<app-header></app-header>

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Left Sidebar -->
    <div class="col-lg-3 col-md-4 mb-4">
      <div class="card profile-sidebar">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-user-circle"></i> My Account</h5>
        </div>
        <div class="list-group list-group-flush">
          <a 
            class="list-group-item list-group-item-action"
            [class.active]="activeSection === 'profile'"
            (click)="setActiveSection('profile')"
            style="cursor: pointer;">
            <i class="fas fa-user"></i> My Profile
          </a>
          <a 
            class="list-group-item list-group-item-action"
            [class.active]="activeSection === 'wishlist'"
            (click)="setActiveSection('wishlist')"
            style="cursor: pointer;">
            <i class="fas fa-heart"></i> Wishlist
          </a>
          <a 
            class="list-group-item list-group-item-action"
            [class.active]="activeSection === 'vouchers'"
            (click)="setActiveSection('vouchers')"
            style="cursor: pointer;">
            <i class="fas fa-ticket-alt"></i> Your Vouchers
          </a>
          <a 
            class="list-group-item list-group-item-action"
            [class.active]="activeSection === 'booking'"
            (click)="setActiveSection('booking')"
            style="cursor: pointer;">
            <i class="fas fa-calendar-check"></i> Your Booking
          </a>
          <a 
            class="list-group-item list-group-item-action"
            [class.active]="activeSection === 'reviews'"
            (click)="setActiveSection('reviews')"
            style="cursor: pointer;">
            <i class="fas fa-star"></i> Your Reviews
          </a>
          <a 
            class="list-group-item list-group-item-action text-danger"
            (click)="logout()"
            style="cursor: pointer;">
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="col-lg-9 col-md-8">
      
      <!-- Profile Section -->
      <div *ngIf="activeSection === 'profile'">
        <!-- Profile Header -->
        <div class="card mb-4">
          <div class="card-body text-center">
            <div class="mb-3">
              <img 
                [src]="avatarUrl" 
                (error)="onAvatarError()"
                alt="User Avatar"
                class="profile-avatar-large"
                onerror="this.src='assets/img/default-avatar.svg'"
              />
            </div>
            <h2 class="card-title">{{ userResponse?.fullname || 'User Profile' }}</h2>
            <p class="text-muted">{{ getRoleName() }} Account</p>
            <div class="d-flex justify-content-center gap-2">
              <button 
                class="btn btn-outline-primary" 
                (click)="toggleEditMode()" 
                *ngIf="!isEditMode">
                <i class="fas fa-edit"></i> Edit Profile
              </button>
            </div>
          </div>
        </div>

      <!-- Profile Information - View Mode -->
              <div class="card" *ngIf="!isEditMode">
                <div class="card-header">
                  <h4><i class="fas fa-info-circle"></i> Profile Information</h4>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <strong><i class="fas fa-user"></i> Full Name:</strong>
                      <p class="mb-0">{{ userResponse?.fullname || 'Not specified' }}</p>
                    </div>
            <div class="col-md-6 mb-3">
              <strong><i class="fas fa-envelope"></i> Email:</strong>
              <p class="mb-0">{{ userResponse?.email || 'Not specified' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <strong><i class="fas fa-user-tag"></i> Role:</strong>
              <span class="badge bg-primary">{{ getRoleName() }}</span>
            </div>
            <div class="col-md-6 mb-3">
              <strong><i class="fas fa-birthday-cake"></i> Date of Birth:</strong>
              <p class="mb-0">{{ formatDate(userResponse?.date_of_birth || '') }}</p>
            </div>
            <div class="col-md-6 mb-3" *ngIf="getUserAge()">
              <strong><i class="fas fa-calendar-alt"></i> Age:</strong>
              <p class="mb-0">{{ getUserAge() }} years old</p>
            </div>
            <div class="col-12 mb-3">
              <strong><i class="fas fa-map-marker-alt"></i> Address:</strong>
              <p class="mb-0">{{ userResponse?.address || 'Not specified' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Information - Edit Mode -->
      <div class="card" *ngIf="isEditMode">
        <div class="card-header">
          <h4><i class="fas fa-edit"></i> Edit Profile</h4>
        </div>
        <div class="card-body">
          <form [formGroup]="userProfileForm">
            
            <!-- Full Name -->
            <div class="mb-3">
              <label for="fullname" class="form-label">
                <i class="fas fa-user"></i> Full Name *
              </label>
              <input 
                type="text" 
                formControlName="fullname" 
                class="form-control" 
                id="fullname" 
                placeholder="Enter your full name"
                [class.is-invalid]="userProfileForm.get('fullname')!.invalid && userProfileForm.get('fullname')!.touched">
              <div 
                *ngIf="userProfileForm.get('fullname')!.invalid && userProfileForm.get('fullname')!.touched" 
                class="invalid-feedback">
                Full name is required (minimum 2 characters).
              </div>
            </div>

            <!-- Address -->
            <div class="mb-3">
              <label for="address" class="form-label">
                <i class="fas fa-map-marker-alt"></i> Address
              </label>
              <textarea 
                formControlName="address" 
                class="form-control" 
                id="address" 
                rows="3"
                placeholder="Enter your address"
                [class.is-invalid]="userProfileForm.get('address')!.invalid && userProfileForm.get('address')!.touched">
              </textarea>
              <div 
                *ngIf="userProfileForm.get('address')!.invalid && userProfileForm.get('address')!.touched" 
                class="invalid-feedback">
                Address must be at least 3 characters.
              </div>
            </div>

            <!-- Date of Birth -->
            <div class="mb-3">
              <label for="date_of_birth" class="form-label">
                <i class="fas fa-birthday-cake"></i> Date of Birth
              </label>
              <input 
                type="date" 
                formControlName="date_of_birth" 
                class="form-control" 
                id="date_of_birth">
            </div>

            <hr>

            <!-- Password Section -->
            <h5 class="mb-3">
              <i class="fas fa-lock"></i> Change Password
              <small class="text-muted">(Leave blank to keep current password)</small>
            </h5>

            <!-- New Password -->
            <div class="mb-3">
              <label for="password" class="form-label">New Password</label>
              <input 
                type="password" 
                class="form-control" 
                formControlName="password"                         
                placeholder="Enter new password (minimum 6 characters)" 
                id="password" 
                [class.is-invalid]="userProfileForm.get('password')!.invalid && userProfileForm.get('password')!.touched">
              <div 
                *ngIf="userProfileForm.get('password')!.invalid && userProfileForm.get('password')!.touched" 
                class="invalid-feedback">
                Password must be at least 6 characters.
              </div>
            </div>

            <!-- Confirm Password -->
            <div class="mb-3">
              <label for="retype_password" class="form-label">Confirm Password</label>
              <input 
                type="password" 
                class="form-control" 
                formControlName="retype_password"                         
                placeholder="Confirm your new password" 
                id="retype_password" 
                [class.is-invalid]="userProfileForm.get('retype_password')!.invalid && userProfileForm.get('retype_password')!.touched">
              <div 
                *ngIf="userProfileForm.hasError('passwordMismatch')" 
                class="invalid-feedback">
                Passwords do not match.
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 justify-content-end">
              <button 
                type="button" 
                class="btn btn-outline-secondary" 
                (click)="cancelEdit()">
                <i class="fas fa-times"></i> Cancel
              </button>
              <button 
                type="button" 
                (click)="save()"
                class="btn btn-primary"
                [disabled]="isLoading || userProfileForm.invalid">
                <i class="fas fa-save" *ngIf="!isLoading"></i>
                <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
                {{ isLoading ? 'Saving...' : 'Save Changes' }}
              </button>
            </div>

          </form>
        </div>
      </div>

      <!-- Additional Information Card -->
      <div class="card mt-4" *ngIf="!isEditMode">
        <div class="card-header">
          <h4><i class="fas fa-info"></i> Account Details</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <strong><i class="fas fa-calendar-plus"></i> Member Since:</strong>
              <p class="mb-0">{{ getMemberSinceDate() }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <strong><i class="fas fa-check-circle"></i> Account Status:</strong>
              <span class="badge bg-success" *ngIf="userResponse?.is_active">Active</span>
              <span class="badge bg-danger" *ngIf="!userResponse?.is_active">Inactive</span>
            </div>
          </div>
          
          <!-- Social Login Info -->
          <div class="mt-3" *ngIf="userResponse?.google_account_id || userResponse?.facebook_account_id">
            <h6><i class="fas fa-link"></i> Connected Accounts:</h6>
            <div class="d-flex gap-2">
              <span class="badge bg-info" *ngIf="userResponse?.google_account_id">
                <i class="fab fa-google"></i> Google Connected
              </span>
              <span class="badge bg-primary" *ngIf="userResponse?.facebook_account_id">
                <i class="fab fa-facebook"></i> Facebook Connected
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- User Statistics Card -->
      <div class="card mt-4" *ngIf="!isEditMode && (userResponse?.total_bookings || userResponse?.favorite_properties_count)">
        <div class="card-header">
          <h4><i class="fas fa-chart-bar"></i> My Statistics</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Guest Statistics -->
            <div class="col-md-4 mb-3" *ngIf="userResponse?.total_bookings !== undefined">
              <div class="stat-card text-center">
                <i class="fas fa-calendar-check fa-2x text-primary mb-2"></i>
                <h3 class="mb-0">{{ userResponse?.total_bookings || 0 }}</h3>
                <small class="text-muted">Total Bookings</small>
              </div>
            </div>
            <div class="col-md-4 mb-3" *ngIf="userResponse?.favorite_properties_count !== undefined">
              <div class="stat-card text-center">
                <i class="fas fa-heart fa-2x text-danger mb-2"></i>
                <h3 class="mb-0">{{ userResponse?.favorite_properties_count || 0 }}</h3>
                <small class="text-muted">Favorite Properties</small>
              </div>
            </div>
            
            <!-- Host Statistics (only for HOST role) -->
            <div class="col-md-4 mb-3" *ngIf="userResponse?.hosted_properties_count !== undefined && getRoleName().toLowerCase() === 'host'">
              <div class="stat-card text-center">
                <i class="fas fa-home fa-2x text-success mb-2"></i>
                <h3 class="mb-0">{{ userResponse?.hosted_properties_count || 0 }}</h3>
                <small class="text-muted">Hosted Properties</small>
              </div>
            </div>
          </div>

          <!-- Additional Host Statistics -->
          <div class="row mt-3" *ngIf="getRoleName().toLowerCase() === 'host' && (userResponse?.total_earnings || userResponse?.average_rating)">
            <div class="col-md-6 mb-3" *ngIf="userResponse?.total_earnings">
              <div class="stat-card text-center">
                <i class="fas fa-dollar-sign fa-2x text-warning mb-2"></i>
                <h3 class="mb-0">${{ userResponse?.total_earnings || 0 }}</h3>
                <small class="text-muted">Total Earnings</small>
              </div>
            </div>
            <div class="col-md-6 mb-3" *ngIf="userResponse?.average_rating">
              <div class="stat-card text-center">
                <i class="fas fa-star fa-2x text-warning mb-2"></i>
                <h3 class="mb-0">{{ userResponse?.average_rating || 0 }}</h3>
                <small class="text-muted">Average Rating</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GUEST Role: Show Bookings -->
      <div class="card mt-4" *ngIf="!isEditMode && getRoleName().toLowerCase() === 'guest'">
        <div class="card-header">
          <h4><i class="fas fa-calendar-check"></i> My Bookings</h4>
        </div>
        <div class="card-body">
          <p class="text-muted">
            <i class="fas fa-info-circle"></i> Your booking history will be displayed here.
          </p>
          <div class="alert alert-info">
            <strong>Coming Soon!</strong> You'll be able to view and manage your bookings from this section.
          </div>
          <!-- TODO: Integrate with booking API to show actual bookings -->
        </div>
      </div>

      <!-- HOST Role: Show Properties and Bookings -->
      <div *ngIf="!isEditMode && getRoleName().toLowerCase() === 'host'">
        
        <!-- Hosted Properties Section -->
        <div class="card mt-4">
          <div class="card-header">
            <h4><i class="fas fa-home"></i> My Properties</h4>
          </div>
          <div class="card-body">
            <p class="text-muted">
              <i class="fas fa-info-circle"></i> Manage your hosted properties here.
            </p>
            <div class="alert alert-info">
              <strong>Coming Soon!</strong> You'll be able to view and manage your properties from this section.
            </div>
            <!-- TODO: Integrate with property API to show actual properties -->
          </div>
        </div>

        <!-- Property Bookings Section -->
        <div class="card mt-4">
          <div class="card-header">
            <h4><i class="fas fa-calendar-alt"></i> Bookings at My Properties</h4>
          </div>
          <div class="card-body">
            <p class="text-muted">
              <i class="fas fa-info-circle"></i> View bookings made by guests at your properties.
            </p>
            <div class="alert alert-info">
              <strong>Coming Soon!</strong> You'll be able to view guest bookings and manage them from this section.
            </div>
            <!-- TODO: Integrate with booking API to show property bookings -->
          </div>
        </div>

        <!-- Host Statistics Section -->
        <div class="card mt-4">
          <div class="card-header">
            <h4><i class="fas fa-chart-line"></i> Host Performance</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center bg-gradient-success">
                  <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                  <h3 class="mb-0">${{ userResponse?.total_earnings || 0 }}</h3>
                  <small class="text-muted">Total Earnings</small>
                </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center bg-gradient-primary">
                  <i class="fas fa-home fa-2x text-primary mb-2"></i>
                  <h3 class="mb-0">{{ userResponse?.hosted_properties_count || 0 }}</h3>
                  <small class="text-muted">Properties Listed</small>
                </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center bg-gradient-warning">
                  <i class="fas fa-star fa-2x text-warning mb-2"></i>
                  <h3 class="mb-0">{{ userResponse?.average_rating || 0 }}</h3>
                  <small class="text-muted">Average Rating</small>
                </div>
              </div>
              <div class="col-md-3 col-sm-6 mb-3">
                <div class="stat-card text-center bg-gradient-info">
                  <i class="fas fa-users fa-2x text-info mb-2"></i>
                  <h3 class="mb-0">{{ userResponse?.total_bookings || 0 }}</h3>
                  <small class="text-muted">Total Bookings</small>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<app-footer></app-footer>